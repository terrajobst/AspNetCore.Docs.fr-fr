---
uid: web-forms/overview/data-access/working-with-batched-data/wrapping-database-modifications-within-a-transaction-vb
title: "Encapsule les Modifications de base de données dans une Transaction (VB) | Documents Microsoft"
author: rick-anderson
description: "Ce didacticiel est la première des quatre examine la mise à jour, suppression et l’insertion des lots de données. Dans ce didacticiel, nous savoir comment autoriser les transactions de base de données..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 06/26/2007
ms.topic: article
ms.assetid: 7d821db5-6cbb-4b38-af14-198f9155fc82
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/data-access/working-with-batched-data/wrapping-database-modifications-within-a-transaction-vb
msc.type: authoredcontent
ms.openlocfilehash: 53887e2cf7b9a60596e2aca16fd1717799ab04f4
ms.sourcegitcommit: 9a9483aceb34591c97451997036a9120c3fe2baf
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 11/10/2017
---
<a name="wrapping-database-modifications-within-a-transaction-vb"></a><span data-ttu-id="1a3d2-104">Modifications de base de données de renvoi à la ligne d’une Transaction (VB)</span><span class="sxs-lookup"><span data-stu-id="1a3d2-104">Wrapping Database Modifications within a Transaction (VB)</span></span>
====================
<span data-ttu-id="1a3d2-105">par [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="1a3d2-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="1a3d2-106">[Télécharger le Code](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_63_VB.zip) ou [télécharger le PDF](wrapping-database-modifications-within-a-transaction-vb/_static/datatutorial63vb1.pdf)</span><span class="sxs-lookup"><span data-stu-id="1a3d2-106">[Download Code](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_63_VB.zip) or [Download PDF](wrapping-database-modifications-within-a-transaction-vb/_static/datatutorial63vb1.pdf)</span></span>

> <span data-ttu-id="1a3d2-107">Ce didacticiel est la première des quatre examine la mise à jour, suppression et l’insertion des lots de données.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-107">This tutorial is the first of four that looks at updating, deleting, and inserting batches of data.</span></span> <span data-ttu-id="1a3d2-108">Ce didacticiel explique comment les transactions de base de données permettent les modifications de lot effectués comme une opération atomique, ce qui garantit que toutes les étapes réussissent ou échouent de toutes les étapes.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-108">In this tutorial we learn how database transactions allow batch modifications to be carried out as an atomic operation, which ensures that either all steps succeed or all steps fail.</span></span>


## <a name="introduction"></a><span data-ttu-id="1a3d2-109">Introduction</span><span class="sxs-lookup"><span data-stu-id="1a3d2-109">Introduction</span></span>

<span data-ttu-id="1a3d2-110">Comme nous l’avons vu en commençant par le [une vue d’ensemble d’insertion, de mise à jour et de suppression des données](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-vb.md) (didacticiel), le contrôle GridView prend en charge la modification au niveau des lignes et suppression.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-110">As we saw starting with the [An Overview of Inserting, Updating, and Deleting Data](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-vb.md) tutorial, the GridView provides built-in support for row-level editing and deleting.</span></span> <span data-ttu-id="1a3d2-111">En quelques clics de souris, il est possible de créer une interface de modification des données riches sans écrire une ligne de code, tant que vous êtes avec la modification et suppression sur une ligne par ligne.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-111">With a few clicks of the mouse it is possible to create a rich data modification interface without writing a line of code, so long as you are content with editing and deleting on a per-row basis.</span></span> <span data-ttu-id="1a3d2-112">Toutefois, dans certains scénarios, cela est insuffisant, et nous avons besoin fournir aux utilisateurs la possibilité de modifier ou supprimer un lot d’enregistrements.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-112">However, in certain scenarios this is insufficient and we need to provide users with the ability to edit or delete a batch of records.</span></span>

<span data-ttu-id="1a3d2-113">Par exemple, basée sur le web plus de clients de messagerie utilisent une grille pour répertorier chaque message dans lequel chaque ligne inclut une case à cocher et des informations de s messagerie (objet, expéditeur et ainsi de suite).</span><span class="sxs-lookup"><span data-stu-id="1a3d2-113">For example, most web-based email clients use a grid to list each message where each row includes a checkbox along with the email s information (subject, sender, and so forth).</span></span> <span data-ttu-id="1a3d2-114">Cette interface permet à l’utilisateur de supprimer plusieurs messages en les archivant et puis en cliquant sur un bouton Supprimer les Messages.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-114">This interface permits the user to delete multiple messages by checking them and then clicking a Delete Selected Messages button.</span></span> <span data-ttu-id="1a3d2-115">Une interface de modification d’une sélection est idéale dans les situations où les utilisateurs modifier fréquemment nombre d’enregistrements.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-115">A batch editing interface is ideal in situations where users commonly edit many different records.</span></span> <span data-ttu-id="1a3d2-116">Au lieu d’obliger l’utilisateur à cliquer sur Modifier, apporter leur modification et puis cliquez sur mise à jour pour chaque enregistrement qui doit être modifiée, une interface de modification d’une sélection restitue chaque ligne avec son interface de modification.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-116">Rather than forcing the user to click Edit, make their change, and then click Update for each record that needs to be modified, a batch editing interface renders each row with its editing interface.</span></span> <span data-ttu-id="1a3d2-117">L’utilisateur peut modifier rapidement l’ensemble de lignes qui doivent être modifiées et puis enregistrer ces modifications en cliquant sur un bouton tout mettre à jour.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-117">The user can quickly modify the set of rows that need to be changed and then save these changes by clicking an Update All button.</span></span> <span data-ttu-id="1a3d2-118">Dans cet ensemble de didacticiels, nous allons examiner comment créer des interfaces pour l’insertion, la modification et la suppression des lots de données.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-118">In this set of tutorials we'll examine how to create interfaces for inserting, editing, and deleting batches of data.</span></span>

<span data-ttu-id="1a3d2-119">Lorsque vous effectuez des opérations par lots il important de déterminer si elle doit être possible de certaines opérations dans le lot réussissent alors que d’autres échouent.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-119">When performing batch operations it s important to determine whether it should be possible for some of the operations in the batch to succeed while others fail.</span></span> <span data-ttu-id="1a3d2-120">Envisagez d’un lot de suppression d’interface - ce qui doit se produire si le premier enregistrement sélectionné est supprimé avec succès, mais la deuxième échoue, par exemple, en raison d’une violation de contrainte de clé étrangère ?</span><span class="sxs-lookup"><span data-stu-id="1a3d2-120">Consider a batch deleting interface - what should happen if the first selected record is deleted successfully, but the second one fails, say, because of a foreign key constraint violation?</span></span> <span data-ttu-id="1a3d2-121">Doit d’abord le supprimer enregistrement s être annulée ou est acceptable pour le premier enregistrement de rester supprimée ?</span><span class="sxs-lookup"><span data-stu-id="1a3d2-121">Should the first record s delete be rolled back or is it acceptable for the first record to remain deleted?</span></span>

<span data-ttu-id="1a3d2-122">Si vous souhaitez l’opération de traitement par lots est traitée comme une [opération atomique](http://en.wikipedia.org/wiki/Atomic_operation), un où soit toutes les étapes de réussissent ou échouent de toutes les étapes et doit être augmenté pour inclure la prise en charge de la couche d’accès aux données [base de données transactions](http://en.wikipedia.org/wiki/Database_transaction).</span><span class="sxs-lookup"><span data-stu-id="1a3d2-122">If you want the batch operation to be treated as an [atomic operation](http://en.wikipedia.org/wiki/Atomic_operation), one where either all of the steps succeed or all of the steps fail, then the Data Access Layer needs to be augmented to include support for [database transactions](http://en.wikipedia.org/wiki/Database_transaction).</span></span> <span data-ttu-id="1a3d2-123">Transactions de base de données garantissent l’atomicité pour l’ensemble de `INSERT`, `UPDATE`, et `DELETE` instructions exécutées dans le cadre de la transaction et sont une fonctionnalité prise en charge par la plupart des tous les systèmes de base de données modernes.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-123">Database transactions guarantee atomicity for the set of `INSERT`, `UPDATE`, and `DELETE` statements executed under the umbrella of the transaction and are a feature supported by most all modern database systems.</span></span>

<span data-ttu-id="1a3d2-124">Dans ce didacticiel, nous allons examiner comment étendre la couche DAL pour utiliser des transactions de base de données.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-124">In this tutorial we'll look at how to extend the DAL to use database transactions.</span></span> <span data-ttu-id="1a3d2-125">Les didacticiels suivants examine les pages web application pour le lot d’insertion, de mise à jour et de suppression des interfaces.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-125">Subsequent tutorials will examine implementing web pages for batch inserting, updating, and deleting interfaces.</span></span> <span data-ttu-id="1a3d2-126">Let s commencer !</span><span class="sxs-lookup"><span data-stu-id="1a3d2-126">Let s get started!</span></span>

> [!NOTE]
> <span data-ttu-id="1a3d2-127">Lors de la modification des données dans une transaction par lot, atomicité n’est pas toujours nécessaire.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-127">When modifying data in a batch transaction, atomicity is not always needed.</span></span> <span data-ttu-id="1a3d2-128">Dans certains scénarios, il peut être acceptable que certaines modifications de données réussisse, et d’autres dans le même lot échouent, par exemple lorsque la suppression d’un ensemble de messages électroniques à partir d’un client de messagerie électronique basé sur le web.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-128">In some scenarios, it may be acceptable to have some data modifications succeed and others in the same batch fail, such as when deleting a set of emails from a web-based email client.</span></span> <span data-ttu-id="1a3d2-129">Si le s’il n’y a un base de données erreur au milieu de la suppression de traitement, il s acceptable que ces enregistrements traités sans erreur restent supprimés.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-129">If there s a database error midway through the deletion process, it s probably acceptable that those records processed without error remain deleted.</span></span> <span data-ttu-id="1a3d2-130">Dans ce cas, la couche Data Access n’a pas besoin être modifiés pour prendre en charge les transactions de base de données.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-130">In such cases, the DAL does not need to be modified to support database transactions.</span></span> <span data-ttu-id="1a3d2-131">Il existe d’autres lot opération scénarios, cependant, où l’atomicité est essentiel.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-131">There are other batch operation scenarios, however, where atomicity is vital.</span></span> <span data-ttu-id="1a3d2-132">Lorsqu’un client met son fonds d’un compte bancaire vers un autre, les deux opérations doivent être exécutées : les fonds doivent être déduits à partir du premier compte et ensuite ajoutées à la seconde.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-132">When a customer moves her funds from one bank account to another, two operations must be performed: the funds must be deducted from the first account and then added to the second.</span></span> <span data-ttu-id="1a3d2-133">Bien que la banque ne peut pas peur la première étape réussir, mais la deuxième étape d’échouer, ses clients, serait énervés.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-133">While the bank may not mind having the first step succeed but the second step fail, its customers would understandably be upset.</span></span> <span data-ttu-id="1a3d2-134">Je vous encourage à utiliser dans ce didacticiel et implémenter les améliorations apportées à la couche DAL pour prendre en charge les transactions de base de données, même si vous n’envisagez pas de leur utilisation dans le lot d’insertion, mise à jour et suppression des interfaces que nous allons créer dans les didacticiels suivants de trois.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-134">I encourage you to work through this tutorial and implement the enhancements to the DAL to support database transactions even if you do not plan on using them in the batch inserting, updating, and deleting interfaces we'll be building in the following three tutorials.</span></span>


## <a name="an-overview-of-transactions"></a><span data-ttu-id="1a3d2-135">Une vue d’ensemble des Transactions</span><span class="sxs-lookup"><span data-stu-id="1a3d2-135">An Overview of Transactions</span></span>

<span data-ttu-id="1a3d2-136">La plupart des bases de données prennent en charge les *transactions*, qui permettent à plusieurs commandes de base de données d’être regroupés en une seule unité logique de travail.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-136">Most databases include support for *transactions*, which enable multiple database commands to be grouped into a single logical unit of work.</span></span> <span data-ttu-id="1a3d2-137">Sont garanti que les commandes de base de données qui composent une transaction atomique, ce qui signifie que toutes les commandes échouent ou réussissent toutes.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-137">The database commands that comprise a transaction are guaranteed to be atomic, meaning that either all commands will fail or all will succeed.</span></span>

<span data-ttu-id="1a3d2-138">En règle générale, les transactions sont implémentées par le biais des instructions SQL à l’aide du modèle suivant :</span><span class="sxs-lookup"><span data-stu-id="1a3d2-138">In general, transactions are implemented through SQL statements using the following pattern:</span></span>

1. <span data-ttu-id="1a3d2-139">Indiquer le début d’une transaction.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-139">Indicate the start of a transaction.</span></span>
2. <span data-ttu-id="1a3d2-140">Exécutez les instructions SQL qui composent la transaction.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-140">Execute the SQL statements that comprise the transaction.</span></span>
3. <span data-ttu-id="1a3d2-141">S’il existe une erreur dans une des instructions à l’étape 2, annuler la transaction.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-141">If there is an error in one of the statements from Step 2, rollback the transaction.</span></span>
4. <span data-ttu-id="1a3d2-142">Si toutes les instructions à l’étape 2 se termine sans erreur, validez la transaction.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-142">If all of the statements from Step 2 complete without error, commit the transaction.</span></span>

<span data-ttu-id="1a3d2-143">Les instructions SQL utilisées pour créer, valider et restaurer la transaction peut être entrée manuellement lors de l’écriture de scripts SQL ou la création de procédures stockées ou par programmation au moyen d’ADO.NET ou les classes dans le [ `System.Transactions` espace de noms](https://msdn.microsoft.com/en-us/library/system.transactions.aspx).</span><span class="sxs-lookup"><span data-stu-id="1a3d2-143">The SQL statements used to create, commit, and roll back the transaction can be entered manually when writing SQL scripts or creating stored procedures, or through programmatic means using either ADO.NET or the classes in the [`System.Transactions` namespace](https://msdn.microsoft.com/en-us/library/system.transactions.aspx).</span></span> <span data-ttu-id="1a3d2-144">Dans ce didacticiel, nous allons examiner uniquement la gestion des transactions à l’aide d’ADO.NET.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-144">In this tutorial we will only examine managing transactions using ADO.NET.</span></span> <span data-ttu-id="1a3d2-145">Dans un didacticiel futur, nous allons examiner comment utiliser des procédures stockées dans la couche d’accès aux données, à ce moment-là que nous allons explorer les instructions SQL pour la création, de restauration et de validation des transactions.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-145">In a future tutorial we will look at how to use stored procedures in the Data Access Layer, at which time we'll explore the SQL statements for creating, rolling back, and committing transactions.</span></span> <span data-ttu-id="1a3d2-146">En attendant, consultez [la gestion des Transactions dans les procédures stockées SQL Server](http://www.4guysfromrolla.com/webtech/080305-1.shtml) pour plus d’informations.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-146">In the meantime, consult [Managing Transactions in SQL Server Stored Procedures](http://www.4guysfromrolla.com/webtech/080305-1.shtml) for more information.</span></span>

> [!NOTE]
> <span data-ttu-id="1a3d2-147">Le [ `TransactionScope` classe](https://msdn.microsoft.com/en-us/library/system.transactions.transactionscope.aspx) dans le `System.Transactions` espace de noms permet aux développeurs de par programmation encapsuler une série d’instructions dans l’étendue d’une transaction et inclut la prise en charge pour les transactions complexes qui impliquent plusieurs sources, telles que les deux bases de données différentes ou hétérogènes types de banques de données, comme une base de données Microsoft SQL Server, une base de données Oracle et un service Web.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-147">The [`TransactionScope` class](https://msdn.microsoft.com/en-us/library/system.transactions.transactionscope.aspx) in the `System.Transactions` namespace enables developers to programmatically wrap a series of statements within the scope of a transaction and includes support for complex transactions that involve multiple sources, such as two different databases or even heterogeneous types of data stores, such as a Microsoft SQL Server database, an Oracle database, and a Web service.</span></span> <span data-ttu-id="1a3d2-148">Je ve décidé d’utiliser des transactions ADO.NET pour ce didacticiel, au lieu du `TransactionScope` classe ADO.NET est plus spécifique pour les transactions de base de données et, dans de nombreux cas, étant donné que nécessite beaucoup moins de ressources.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-148">I ve decided to use ADO.NET transactions for this tutorial instead of the `TransactionScope` class because ADO.NET is more specific for database transactions and, in many cases, is far less resource intensive.</span></span> <span data-ttu-id="1a3d2-149">En outre, dans certains cas le `TransactionScope` classe utilise Microsoft Distributed Transaction Coordinator (MSDTC).</span><span class="sxs-lookup"><span data-stu-id="1a3d2-149">In addition, under certain scenarios the `TransactionScope` class uses the Microsoft Distributed Transaction Coordinator (MSDTC).</span></span> <span data-ttu-id="1a3d2-150">Les problèmes de configuration, l’implémentation et performances MSDTC environnante rend une rubrique plutôt spécialisée et avancée et dépasse le cadre de ces didacticiels.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-150">The configuration, implementation, and performance issues surrounding MSDTC makes it a rather specialized and advanced topic and beyond the scope of these tutorials.</span></span>


<span data-ttu-id="1a3d2-151">Lorsque vous travaillez avec le fournisseur SqlClient dans ADO.NET, les transactions sont lancées par un appel à la [ `SqlConnection` classe](https://msdn.microsoft.com/en-US/library/system.data.sqlclient.sqlconnection.aspx) s [ `BeginTransaction` méthode](https://msdn.microsoft.com/en-us/library/system.data.sqlclient.sqlconnection.begintransaction.aspx), qui retourne un [ `SqlTransaction` objet](https://msdn.microsoft.com/en-US/library/system.data.sqlclient.sqltransaction.aspx).</span><span class="sxs-lookup"><span data-stu-id="1a3d2-151">When working with the SqlClient provider in ADO.NET, transactions are initiated through a call to the [`SqlConnection` class](https://msdn.microsoft.com/en-US/library/system.data.sqlclient.sqlconnection.aspx) s [`BeginTransaction` method](https://msdn.microsoft.com/en-us/library/system.data.sqlclient.sqlconnection.begintransaction.aspx), which returns a [`SqlTransaction` object](https://msdn.microsoft.com/en-US/library/system.data.sqlclient.sqltransaction.aspx).</span></span> <span data-ttu-id="1a3d2-152">Les instructions de modification de données la transaction de composition sont placés dans un `try...catch` bloc.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-152">The data modification statements that makeup the transaction are placed within a `try...catch` block.</span></span> <span data-ttu-id="1a3d2-153">Si une erreur se produit dans une instruction dans le `try` bloquer, les transferts de l’exécution à la `catch` bloc dans lequel la transaction peut être annulée via le `SqlTransaction` objet s [ `Rollback` (méthode)](https://msdn.microsoft.com/en-us/library/system.data.sqlclient.sqltransaction.rollback.aspx).</span><span class="sxs-lookup"><span data-stu-id="1a3d2-153">If an error occurs in a statement in the `try` block, execution transfers to the `catch` block where the transaction can be rolled back via the `SqlTransaction` object s [`Rollback` method](https://msdn.microsoft.com/en-us/library/system.data.sqlclient.sqltransaction.rollback.aspx).</span></span> <span data-ttu-id="1a3d2-154">Si toutes les instructions terminent correctement, un appel à la `SqlTransaction` objet s [ `Commit` méthode](https://msdn.microsoft.com/en-us/library/system.data.sqlclient.sqltransaction.commit.aspx) à la fin de la `try` bloc valide la transaction.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-154">If all of the statements complete successfully, a call to the `SqlTransaction` object s [`Commit` method](https://msdn.microsoft.com/en-us/library/system.data.sqlclient.sqltransaction.commit.aspx) at the end of the `try` block commits the transaction.</span></span> <span data-ttu-id="1a3d2-155">L’extrait de code suivant illustre ce modèle.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-155">The following code snippet illustrates this pattern.</span></span> <span data-ttu-id="1a3d2-156">Consultez [maintenance de la cohérence de base de données avec des Transactions](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx) de syntaxe supplémentaire et des exemples d’utilisation de transactions avec ADO.NET.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-156">See [Maintaining Database Consistency with Transactions](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx) for additional syntax and examples of using transactions with ADO.NET.</span></span>


[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample1.vb)]

<span data-ttu-id="1a3d2-157">Par défaut, les TableAdapters dans un DataSet typé n’utilisez pas de transactions.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-157">By default, the TableAdapters in a Typed DataSet do not use transactions.</span></span> <span data-ttu-id="1a3d2-158">Pour prendre en charge pour les transactions que nous avons besoin d’augmenter les classes TableAdapter pour inclure des méthodes supplémentaires qui utilisent le modèle ci-dessus pour effectuer une série d’instructions de modification de données dans l’étendue d’une transaction.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-158">To provide support for transactions we need to augment the TableAdapter classes to include additional methods that use the above pattern to perform a series of data modification statements within the scope of a transaction.</span></span> <span data-ttu-id="1a3d2-159">À l’étape 2, nous verrons comment utiliser des classes partielles pour ajouter ces méthodes.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-159">In Step 2 we'll see how to use partial classes to add these methods.</span></span>

## <a name="step-1-creating-the-working-with-batched-data-web-pages"></a><span data-ttu-id="1a3d2-160">Étape 1 : Création de la plage de travail avec des Pages Web de données par lot</span><span class="sxs-lookup"><span data-stu-id="1a3d2-160">Step 1: Creating the Working with Batched Data Web Pages</span></span>

<span data-ttu-id="1a3d2-161">Avant de commencer à Explorer la manière d’améliorer la couche DAL pour prendre en charge les transactions de base de données, permettent de s Prenez tout d’abord créer les pages web ASP.NET qui sera nécessaire pour ce didacticiel et les trois qui suivent.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-161">Before we start exploring how to augment the DAL to support database transactions, let s first take a moment to create the ASP.NET web pages that we will need for this tutorial and the three that follow.</span></span> <span data-ttu-id="1a3d2-162">Commencez par ajouter un nouveau dossier nommé `BatchData` , puis ajoutez les pages ASP.NET suivantes, en associant chaque page avec le `Site.master` page maître.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-162">Start by adding a new folder named `BatchData` and then add the following ASP.NET pages, associating each page with the `Site.master` master page.</span></span>

- `Default.aspx`
- `Transactions.aspx`
- `BatchUpdate.aspx`
- `BatchDelete.aspx`
- `BatchInsert.aspx`


![Ajouter les Pages ASP.NET pour les didacticiels de SqlDataSource](wrapping-database-modifications-within-a-transaction-vb/_static/image1.gif)

<span data-ttu-id="1a3d2-164">**Figure 1**: ajouter les Pages ASP.NET pour les didacticiels de SqlDataSource</span><span class="sxs-lookup"><span data-stu-id="1a3d2-164">**Figure 1**: Add the ASP.NET Pages for the SqlDataSource-Related Tutorials</span></span>


<span data-ttu-id="1a3d2-165">Comme avec les autres dossiers, `Default.aspx` utilisera le `SectionLevelTutorialListing.ascx` contrôle utilisateur pour répertorier les didacticiels dans sa section.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-165">As with the other folders, `Default.aspx` will use the `SectionLevelTutorialListing.ascx` User Control to list the tutorials within its section.</span></span> <span data-ttu-id="1a3d2-166">Par conséquent, ajoutez ce contrôle utilisateur pour `Default.aspx` en le faisant glisser à partir de l’Explorateur de solutions sur la page s mode Création.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-166">Therefore, add this User Control to `Default.aspx` by dragging it from the Solution Explorer onto the page s Design view.</span></span>


<span data-ttu-id="1a3d2-167">[![Ajouter le contrôle utilisateur de SectionLevelTutorialListing.ascx vers Default.aspx](wrapping-database-modifications-within-a-transaction-vb/_static/image2.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="1a3d2-167">[![Add the SectionLevelTutorialListing.ascx User Control to Default.aspx](wrapping-database-modifications-within-a-transaction-vb/_static/image2.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image1.png)</span></span>

<span data-ttu-id="1a3d2-168">**Figure 2**: ajouter la `SectionLevelTutorialListing.ascx` contrôle utilisateur à `Default.aspx` ([cliquez pour afficher l’image en taille réelle](wrapping-database-modifications-within-a-transaction-vb/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="1a3d2-168">**Figure 2**: Add the `SectionLevelTutorialListing.ascx` User Control to `Default.aspx` ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image2.png))</span></span>


<span data-ttu-id="1a3d2-169">Enfin, ajoutez ces quatre pages en tant qu’entrées pour les `Web.sitemap` fichier.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-169">Lastly, add these four pages as entries to the `Web.sitemap` file.</span></span> <span data-ttu-id="1a3d2-170">En particulier, ajoutez le balisage suivant après la personnalisation sitemap `<siteMapNode>`:</span><span class="sxs-lookup"><span data-stu-id="1a3d2-170">Specifically, add the following markup after the Customizing the Site Map `<siteMapNode>`:</span></span>


[!code-xml[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample2.xml)]

<span data-ttu-id="1a3d2-171">Après la mise à jour `Web.sitemap`, prenez un moment pour afficher le site Web des didacticiels via un navigateur.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-171">After updating `Web.sitemap`, take a moment to view the tutorials website through a browser.</span></span> <span data-ttu-id="1a3d2-172">Le menu de gauche inclut désormais les éléments de la plage de travail dans les didacticiels de données par lot.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-172">The menu on the left now includes items for the working with batched data tutorials.</span></span>


![Le plan de Site inclut maintenant des entrées pour la plage de travail dans les didacticiels de données par lot](wrapping-database-modifications-within-a-transaction-vb/_static/image3.gif)

<span data-ttu-id="1a3d2-174">**Figure 3**: le plan de Site inclut maintenant des entrées pour la plage de travail dans les didacticiels de données par lot</span><span class="sxs-lookup"><span data-stu-id="1a3d2-174">**Figure 3**: The Site Map Now Includes Entries for the Working with Batched Data Tutorials</span></span>


## <a name="step-2-updating-the-data-access-layer-to-support-database-transactions"></a><span data-ttu-id="1a3d2-175">Étape 2 : Mise à jour de la couche d’accès aux données pour prendre en charge les Transactions de base de données</span><span class="sxs-lookup"><span data-stu-id="1a3d2-175">Step 2: Updating the Data Access Layer to Support Database Transactions</span></span>

<span data-ttu-id="1a3d2-176">Comme expliqué dans le premier didacticiel [création d’une couche d’accès aux données](../introduction/creating-a-data-access-layer-vb.md), le DataSet typé dans notre DAL se compose de tables de données et les TableAdapters.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-176">As we discussed back in the first tutorial, [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-vb.md), the Typed DataSet in our DAL is composed of DataTables and TableAdapters.</span></span> <span data-ttu-id="1a3d2-177">Les tables de données contiennent des données tandis que les TableAdapters fournissent les fonctionnalités permettant de lire les données à partir de la base de données dans les tables de données, mettre à jour la base de données avec les modifications apportées aux tables de données et ainsi de suite.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-177">The DataTables hold data while the TableAdapters provide the functionality to read data from the database into the DataTables, to update the database with changes made to the DataTables, and so forth.</span></span> <span data-ttu-id="1a3d2-178">Rappelez-vous que les TableAdapters fournissent deux modèles de mise à jour des données, j’ai appelé mise à jour par lots et Direct à la base de données.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-178">Recall that the TableAdapters provide two patterns for updating data, which I referred to as Batch Update and DB-Direct.</span></span> <span data-ttu-id="1a3d2-179">Avec le modèle de mise à jour par lots, le TableAdapter est passé d’un DataSet, DataTable ou collection de DataRows.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-179">With the Batch Update pattern, the TableAdapter is passed a DataSet, DataTable, or collection of DataRows.</span></span> <span data-ttu-id="1a3d2-180">Ces données est énumérées et pour chaque inséré, modifié ou supprimé des lignes, le `InsertCommand`, `UpdateCommand`, ou `DeleteCommand` est exécutée.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-180">This data is enumerated and for each inserted, modified, or deleted row, the `InsertCommand`, `UpdateCommand`, or `DeleteCommand` is executed.</span></span> <span data-ttu-id="1a3d2-181">Avec le modèle de base de données en Direct, le TableAdapter est passé à la place des valeurs des colonnes nécessaires pour l’insertion, la mise à jour ou suppression d’un enregistrement unique.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-181">With the DB-Direct pattern, the TableAdapter is instead passed the values of the columns necessary for inserting, updating, or deleting a single record.</span></span> <span data-ttu-id="1a3d2-182">La méthode Direct de base de données utilise ensuite ces valeurs dans le passé pour exécuter la commande appropriée `InsertCommand`, `UpdateCommand`, ou `DeleteCommand` instruction.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-182">The DB Direct pattern method then uses those passed-in values to execute the appropriate `InsertCommand`, `UpdateCommand`, or `DeleteCommand` statement.</span></span>

<span data-ttu-id="1a3d2-183">Quel que soit le modèle de mise à jour utilisé, les méthodes générées automatiquement des TableAdapters n’utilisent pas de transactions.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-183">Regardless of the update pattern used, the TableAdapters auto-generated methods do not use transactions.</span></span> <span data-ttu-id="1a3d2-184">Par défaut, chaque insert, update ou delete exécutée par le TableAdapter est traité comme une seule opération discrète.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-184">By default each insert, update, or delete performed by the TableAdapter is treated as a single discrete operation.</span></span> <span data-ttu-id="1a3d2-185">Par exemple, imaginez que le modèle de base de données en Direct est utilisé par du code dans la couche BLL pour insérer des dix enregistrements dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-185">For instance, imagine that the DB-Direct pattern is used by some code in the BLL to insert ten records into the database.</span></span> <span data-ttu-id="1a3d2-186">Ce code appelle le TableAdapter s `Insert` méthode dix fois.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-186">This code would call the TableAdapter s `Insert` method ten times.</span></span> <span data-ttu-id="1a3d2-187">Si les cinq premiers insertions réussissent, mais celui sixième a entraîné une exception, les cinq premiers enregistrements insérés reste dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-187">If the first five inserts succeed, but the sixth one resulted in an exception, the first five inserted records would remain in the database.</span></span> <span data-ttu-id="1a3d2-188">De même, si le modèle de mise à jour par lots est utilisé pour effectuer des insertions, mises à jour et des suppressions inséré, modifié et supprimé des lignes dans un DataTable, si les modifications de plusieurs première a réussi, mais une version plus récente a rencontré une erreur, les modifications antérieures qui terminée reste dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-188">Similarly, if the Batch Update pattern is used to perform inserts, updates, and deletes to the inserted, modified, and deleted rows in a DataTable, if the first several modifications succeeded but a later one encountered an error, those earlier modifications that completed would remain in the database.</span></span>

<span data-ttu-id="1a3d2-189">Dans certains scénarios, vous souhaitez garantir l’atomicité sur une série de modifications.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-189">In certain scenarios we want to ensure atomicity across a series of modifications.</span></span> <span data-ttu-id="1a3d2-190">Pour cela nous devons étendre manuellement le TableAdapter en ajoutant de nouvelles méthodes qui s’exécutent la `InsertCommand`, `UpdateCommand`, et `DeleteCommand` s dans le cadre d’une transaction.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-190">To accomplish this we must manually extend the TableAdapter by adding new methods that execute the `InsertCommand`, `UpdateCommand`, and `DeleteCommand` s under the umbrella of a transaction.</span></span> <span data-ttu-id="1a3d2-191">Dans [création d’une couche d’accès aux données](../introduction/creating-a-data-access-layer-vb.md) , nous avons étudié à l’aide de [classes partielles](http://en.wikipedia.org/wiki/Partial_type) pour étendre les fonctionnalités des tables de données dans le DataSet typé.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-191">In [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-vb.md) we looked at using [partial classes](http://en.wikipedia.org/wiki/Partial_type) to extend the functionality of the DataTables within the Typed DataSet.</span></span> <span data-ttu-id="1a3d2-192">Cette technique peut également être utilisée avec des TableAdapters.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-192">This technique can also be used with TableAdapters.</span></span>

<span data-ttu-id="1a3d2-193">Le DataSet typé `Northwind.xsd` se trouve dans le `App_Code` dossier s `DAL` sous-dossier.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-193">The Typed DataSet `Northwind.xsd` is located in the `App_Code` folder s `DAL` subfolder.</span></span> <span data-ttu-id="1a3d2-194">Créer un sous-dossier dans le `DAL` dossier nommé `TransactionSupport` et ajoutez un nouveau fichier de classe nommé `ProductsTableAdapter.TransactionSupport.vb` (voir Figure 4).</span><span class="sxs-lookup"><span data-stu-id="1a3d2-194">Create a subfolder in the `DAL` folder named `TransactionSupport` and add a new class file named `ProductsTableAdapter.TransactionSupport.vb` (see Figure 4).</span></span> <span data-ttu-id="1a3d2-195">Ce fichier contiendra l’implémentation partielle de la `ProductsTableAdapter` qui inclut des méthodes permettant d’effectuer des modifications de données à l’aide d’une transaction.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-195">This file will hold the partial implementation of the `ProductsTableAdapter` that includes methods for performing data modifications using a transaction.</span></span>


![Ajouter un dossier nommé TransactionSupport et un fichier de classe nommé ProductsTableAdapter.TransactionSupport.vb](wrapping-database-modifications-within-a-transaction-vb/_static/image4.gif)

<span data-ttu-id="1a3d2-197">**Figure 4**: ajouter un dossier nommé `TransactionSupport` et un fichier de classe nommé`ProductsTableAdapter.TransactionSupport.vb`</span><span class="sxs-lookup"><span data-stu-id="1a3d2-197">**Figure 4**: Add a Folder Named `TransactionSupport` and a Class File Named `ProductsTableAdapter.TransactionSupport.vb`</span></span>


<span data-ttu-id="1a3d2-198">Entrez le code suivant dans le `ProductsTableAdapter.TransactionSupport.vb` fichier :</span><span class="sxs-lookup"><span data-stu-id="1a3d2-198">Enter the following code into the `ProductsTableAdapter.TransactionSupport.vb` file:</span></span>


[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample3.vb)]

<span data-ttu-id="1a3d2-199">Le `Partial` mot clé dans la déclaration de classe ici indique au compilateur que les membres ajoutés doivent être ajoutés à la `ProductsTableAdapter` classe dans le `NorthwindTableAdapters` espace de noms.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-199">The `Partial` keyword in the class declaration here indicates to the compiler that the members added within are to be added to the `ProductsTableAdapter` class in the `NorthwindTableAdapters` namespace.</span></span> <span data-ttu-id="1a3d2-200">Remarque la `Imports System.Data.SqlClient` instruction en haut du fichier.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-200">Note the `Imports System.Data.SqlClient` statement at the top of the file.</span></span> <span data-ttu-id="1a3d2-201">Puisque le TableAdapter a été configuré pour utiliser le fournisseur SqlClient, en interne il utilise un [ `SqlDataAdapter` ](https://msdn.microsoft.com/en-us/library/system.data.sqlclient.sqldataadapter.aspx) objet pour émettre ses commandes à la base de données.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-201">Since the TableAdapter was configured to use the SqlClient provider, internally it uses a [`SqlDataAdapter`](https://msdn.microsoft.com/en-us/library/system.data.sqlclient.sqldataadapter.aspx) object to issue its commands to the database.</span></span> <span data-ttu-id="1a3d2-202">Par conséquent, nous devons utiliser la `SqlTransaction` classe pour commencer la transaction, puis de valider ou restaurer.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-202">Consequently, we need to use the `SqlTransaction` class to begin the transaction and then to commit it or roll it back.</span></span> <span data-ttu-id="1a3d2-203">Si vous utilisez un magasin de données autre que Microsoft SQL Server, vous devez utiliser le fournisseur approprié.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-203">If you are using a data store other than Microsoft SQL Server, you'll need to use the appropriate provider.</span></span>

<span data-ttu-id="1a3d2-204">Ces méthodes fournissent les blocs de construction nécessaires au démarrage, de restauration et de valider une transaction.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-204">These methods provide the building blocks needed to start, rollback, and commit a transaction.</span></span> <span data-ttu-id="1a3d2-205">Ils sont marqués `Public`, ce qui leur permet d’être utilisé à partir du `ProductsTableAdapter`, à partir d’une autre classe dans la couche DAL, ou à partir d’une autre couche de l’architecture, telles que la couche BLL.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-205">They are marked `Public`, enabling them to be used from within the `ProductsTableAdapter`, from another class in the DAL, or from another layer in the architecture, such as the BLL.</span></span> <span data-ttu-id="1a3d2-206">`BeginTransaction`Ouvre le TableAdapter interne `SqlConnection` (si nécessaire), démarre la transaction et l’affecte à la `Transaction` propriété et joint la transaction au interne `SqlDataAdapter` s `SqlCommand` objets.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-206">`BeginTransaction` opens the TableAdapter s internal `SqlConnection` (if needed), begins the transaction and assigns it to the `Transaction` property, and attaches the transaction to the internal `SqlDataAdapter` s `SqlCommand` objects.</span></span> <span data-ttu-id="1a3d2-207">`CommitTransaction`et `RollbackTransaction` appeler le `Transaction` objet s `Commit` et `Rollback` méthodes, respectivement, avant de fermer interne `Connection` objet.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-207">`CommitTransaction` and `RollbackTransaction` call the `Transaction` object s `Commit` and `Rollback` methods, respectively, before closing the internal `Connection` object.</span></span>

## <a name="step-3-adding-methods-to-update-and-delete-data-under-the-umbrella-of-a-transaction"></a><span data-ttu-id="1a3d2-208">Étape 3 : Ajout de méthodes pour mettre à jour et supprimer des données dans le cadre d’une Transaction</span><span class="sxs-lookup"><span data-stu-id="1a3d2-208">Step 3: Adding Methods to Update and Delete Data Under the Umbrella of a Transaction</span></span>

<span data-ttu-id="1a3d2-209">Avec ces méthodes terminées, nous re prêt pour ajouter des méthodes à `ProductsDataTable` ou la couche BLL qui effectuent une série de commandes dans le cadre d’une transaction.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-209">With these methods complete, we re ready to add methods to `ProductsDataTable` or the BLL that perform a series of commands under the umbrella of a transaction.</span></span> <span data-ttu-id="1a3d2-210">La méthode suivante utilise le modèle de mise à jour par lot pour mettre à jour un `ProductsDataTable` instance à l’aide d’une transaction.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-210">The following method uses the Batch Update pattern to update a `ProductsDataTable` instance using a transaction.</span></span> <span data-ttu-id="1a3d2-211">Il démarre une transaction en appelant le `BeginTransaction` (méthode), puis utilise une `Try...Catch` bloc pour émettre les instructions de modification de données.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-211">It starts a transaction by calling the `BeginTransaction` method and then uses a `Try...Catch` block to issue the data modification statements.</span></span> <span data-ttu-id="1a3d2-212">Si l’appel à la `Adapter` objet s `Update` méthode entraîne une exception, l’exécution est transférés vers le `catch` bloc où la transaction sera restaurée et l’exception levée à nouveau.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-212">If the call to the `Adapter` object s `Update` method results in an exception, execution will transfer to the `catch` block where the transaction will be rolled back and the exception re-thrown.</span></span> <span data-ttu-id="1a3d2-213">N’oubliez pas que le `Update` méthode implémente le modèle de mise à jour par lots en énumérant les lignes de l’élément `ProductsDataTable` et d’exécution nécessaires `InsertCommand`, `UpdateCommand`, et `DeleteCommand` s.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-213">Recall that the `Update` method implements the Batch Update pattern by enumerating the rows of the supplied `ProductsDataTable` and performing the necessary `InsertCommand`, `UpdateCommand`, and `DeleteCommand` s.</span></span> <span data-ttu-id="1a3d2-214">Si l’une de ces commandes une erreur, la transaction est restaurée, annuler les modifications précédentes effectuées pendant la durée de vie de s de transaction.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-214">If any one of these commands results in an error, the transaction is rolled back, undoing the previous modifications made during the transaction s lifetime.</span></span> <span data-ttu-id="1a3d2-215">Doit la `Update` instruction se termine sans erreur, la transaction est validée dans son intégralité.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-215">Should the `Update` statement complete without error, the transaction is committed in its entirety.</span></span>


[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample4.vb)]

<span data-ttu-id="1a3d2-216">Ajouter le `UpdateWithTransaction` méthode à la `ProductsTableAdapter` classe via la classe partielle dans `ProductsTableAdapter.TransactionSupport.vb`.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-216">Add the `UpdateWithTransaction` method to the `ProductsTableAdapter` class through the partial class in `ProductsTableAdapter.TransactionSupport.vb`.</span></span> <span data-ttu-id="1a3d2-217">Sinon, cette méthode peut être ajoutée à la couche de logique métier s `ProductsBLL` classe avec quelques modifications syntaxiques mineures.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-217">Alternatively, this method could be added to the Business Logic Layer s `ProductsBLL` class with a few minor syntactical changes.</span></span> <span data-ttu-id="1a3d2-218">À savoir, le mot clé `Me` dans `Me.BeginTransaction()`, `Me.CommitTransaction()`, et `Me.RollbackTransaction()` devra être remplacé par `Adapter` (n’oubliez pas que `Adapter` est le nom d’une propriété dans `ProductsBLL` de type `ProductsTableAdapter`).</span><span class="sxs-lookup"><span data-stu-id="1a3d2-218">Namely, the keyword `Me` in `Me.BeginTransaction()`, `Me.CommitTransaction()`, and `Me.RollbackTransaction()` would need to be replaced with `Adapter` (recall that `Adapter` is the name of a property in `ProductsBLL` of type `ProductsTableAdapter`).</span></span>

<span data-ttu-id="1a3d2-219">Le `UpdateWithTransaction` méthode utilise le modèle de mise à jour par lots, mais une série d’appels de base de données en Direct peut également être utilisée dans l’étendue d’une transaction, comme dans l’exemple de méthode suivant.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-219">The `UpdateWithTransaction` method uses the Batch Update pattern, but a series of DB-Direct calls can also be used within the scope of a transaction, as the following method shows.</span></span> <span data-ttu-id="1a3d2-220">Le `DeleteProductsWithTransaction` méthode accepte comme entrée un `List(Of T)` de type `Integer`, qui sont le `ProductID` s à supprimer.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-220">The `DeleteProductsWithTransaction` method accepts as input a `List(Of T)` of type `Integer`, which are the `ProductID` s to delete.</span></span> <span data-ttu-id="1a3d2-221">La méthode lance la transaction via un appel à `BeginTransaction` , puis, dans le `Try` de bloc, effectue une itération dans la liste fournie, le modèle de base de données en Direct de l’appel `Delete` méthode pour chaque `ProductID` valeur.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-221">The method initiates the transaction via a call to `BeginTransaction` and then, in the `Try` block, iterates through the supplied list calling the DB-Direct pattern `Delete` method for each `ProductID` value.</span></span> <span data-ttu-id="1a3d2-222">Si un des appels à `Delete` échoue, le contrôle est transféré vers le `Catch` bloc dans lequel la transaction est annulée et l’exception levée à nouveau.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-222">If any of the calls to `Delete` fails, control is transferred to the `Catch` block where the transaction is rolled back and the exception re-thrown.</span></span> <span data-ttu-id="1a3d2-223">Si tous les appels à `Delete` réussisse, puis de la transaction est validée.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-223">If all calls to `Delete` succeed, then transaction is committed.</span></span> <span data-ttu-id="1a3d2-224">Ajoutez cette méthode à la `ProductsBLL` classe.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-224">Add this method to the `ProductsBLL` class.</span></span>


[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample5.vb)]

## <a name="applying-transactions-across-multiple-tableadapters"></a><span data-ttu-id="1a3d2-225">Application de Transactions entre plusieurs TableAdapters</span><span class="sxs-lookup"><span data-stu-id="1a3d2-225">Applying Transactions Across Multiple TableAdapters</span></span>

<span data-ttu-id="1a3d2-226">Le code lié à la transaction examiné dans ce didacticiel permet pour plusieurs instructions par rapport à la `ProductsTableAdapter` est traitée comme une opération atomique.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-226">The transaction-related code examined in this tutorial allows for multiple statements against the `ProductsTableAdapter` to be treated as an atomic operation.</span></span> <span data-ttu-id="1a3d2-227">Mais que se passe-t-il si plusieurs modifications aux tables de base de données différente doivent être effectuées de manière atomique ?</span><span class="sxs-lookup"><span data-stu-id="1a3d2-227">But what if multiple modifications to different database tables need to be performed atomically?</span></span> <span data-ttu-id="1a3d2-228">Par exemple, lorsque vous supprimez une catégorie, nous pouvons tout d’abord souhaitez réaffecter ses produits en cours à une autre catégorie.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-228">For instance, when deleting a category, we might first want to reassign its current products to some other category.</span></span> <span data-ttu-id="1a3d2-229">Ces deux étapes, en réaffectant les produits et de suppression de la catégorie doivent être exécutés comme une opération atomique.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-229">These two steps reassigning the products and deleting the category should be executed as an atomic operation.</span></span> <span data-ttu-id="1a3d2-230">Mais la `ProductsTableAdapter` inclut uniquement les méthodes permettant de modifier le `Products` table et la `CategoriesTableAdapter` inclut uniquement les méthodes de modification le `Categories` table.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-230">But the `ProductsTableAdapter` includes only methods for modifying the `Products` table and the `CategoriesTableAdapter` includes only methods for modifying the `Categories` table.</span></span> <span data-ttu-id="1a3d2-231">Comment une transaction peut englober les TableAdapters ?</span><span class="sxs-lookup"><span data-stu-id="1a3d2-231">So how can a transaction encompass both TableAdapters?</span></span>

<span data-ttu-id="1a3d2-232">Une option consiste à ajouter une méthode à la `CategoriesTableAdapter` nommé `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` et faites en sorte que cette méthode appelle une procédure stockée qui supprime la catégorie dans l’étendue d’une transaction définie dans la procédure stockée et réaffecte les produits.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-232">One option is to add a method to the `CategoriesTableAdapter` named `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` and have that method call a stored procedure that both reassigns the products and deletes the category within the scope of a transaction defined within the stored procedure.</span></span> <span data-ttu-id="1a3d2-233">Nous allons examiner comment commencer, valider et annuler les transactions dans les procédures stockées dans un didacticiel futures.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-233">We'll look at how to begin, commit, and rollback transactions in stored procedures in a future tutorial.</span></span>

<span data-ttu-id="1a3d2-234">Une autre option consiste à créer une classe d’assistance dans la couche DAL qui contient le `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` (méthode).</span><span class="sxs-lookup"><span data-stu-id="1a3d2-234">Another option is to create a helper class in the DAL that contains the `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` method.</span></span> <span data-ttu-id="1a3d2-235">Cette méthode créerait une instance de la `CategoriesTableAdapter` et `ProductsTableAdapter` et définir ces deux TableAdapters `Connection` propriétés à la même `SqlConnection` instance.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-235">This method would create an instance of the `CategoriesTableAdapter` and the `ProductsTableAdapter` and then set these two TableAdapters `Connection` properties to the same `SqlConnection` instance.</span></span> <span data-ttu-id="1a3d2-236">À ce stade, l’une des deux TableAdapters lancer la transaction avec un appel à `BeginTransaction`.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-236">At that point, either one of the two TableAdapters would initiate the transaction with a call to `BeginTransaction`.</span></span> <span data-ttu-id="1a3d2-237">Les méthodes des TableAdapters pour réaffecter les produits et la suppression de la catégorie sont appelés dans un `Try...Catch` bloc avec la transaction validée ou annulée précédent en fonction des besoins.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-237">The TableAdapters methods for reassigning the products and deleting the category would be invoked in a `Try...Catch` block with the transaction committed or rolled back as needed.</span></span>

## <a name="step-4-adding-theupdatewithtransactionmethod-to-the-business-logic-layer"></a><span data-ttu-id="1a3d2-238">Étape 4 : Ajout de la`UpdateWithTransaction`à la couche de logique métier (méthode)</span><span class="sxs-lookup"><span data-stu-id="1a3d2-238">Step 4: Adding the`UpdateWithTransaction`Method to the Business Logic Layer</span></span>

<span data-ttu-id="1a3d2-239">À l’étape 3, nous avons ajouté une `UpdateWithTransaction` méthode à la `ProductsTableAdapter` dans la couche DAL.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-239">In Step 3 we added an `UpdateWithTransaction` method to the `ProductsTableAdapter` in the DAL.</span></span> <span data-ttu-id="1a3d2-240">Nous devons ajouter une méthode correspondante à la couche BLL.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-240">We should add a corresponding method to the BLL.</span></span> <span data-ttu-id="1a3d2-241">Même si la couche de présentation peut appeler directement à la couche DAL pour appeler le `UpdateWithTransaction` (méthode), ces didacticiels entièrement définir une architecture multiniveau qui isole la couche DAL à partir de la couche de présentation.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-241">While the Presentation Layer could call directly down to the DAL to invoke the `UpdateWithTransaction` method, these tutorials have strived to define a layered architecture that insulates the DAL from the Presentation Layer.</span></span> <span data-ttu-id="1a3d2-242">Par conséquent, il nous pour continuer cette approche appartient.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-242">Therefore, it behooves us to continue this approach.</span></span>

<span data-ttu-id="1a3d2-243">Ouvrez le `ProductsBLL` fichier de classe et ajoutez une méthode nommée `UpdateWithTransaction` qui appelle simplement à la méthode correspondante de la couche DAL.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-243">Open the `ProductsBLL` class file and add a method named `UpdateWithTransaction` that simply calls down to the corresponding DAL method.</span></span> <span data-ttu-id="1a3d2-244">Il convient maintenant deux nouvelles méthodes de `ProductsBLL`: `UpdateWithTransaction`, ce qui vous venez d’ajouter, et `DeleteProductsWithTransaction`, qui a été ajouté à l’étape 3.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-244">There should now be two new methods in `ProductsBLL`: `UpdateWithTransaction`, which you just added, and `DeleteProductsWithTransaction`, which was added in Step 3.</span></span>


[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample6.vb)]

> [!NOTE]
> <span data-ttu-id="1a3d2-245">Ces méthodes n’incluent pas la `DataObjectMethodAttribute` attribut assigné à la plupart des autres méthodes dans le `ProductsBLL` , car nous allons appeler ces méthodes directement à partir des classes ASP.NET pages code-behind de la classe.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-245">These methods do not include the `DataObjectMethodAttribute` attribute assigned to most other methods in the `ProductsBLL` class because we'll be invoking these methods directly from the ASP.NET pages code-behind classes.</span></span> <span data-ttu-id="1a3d2-246">N’oubliez pas que `DataObjectMethodAttribute` est utilisé pour marquer les méthodes qui doivent apparaître dans le s ObjectDataSource configurer la Source de données Assistant et sous l’onglet (SELECT, UPDATE, INSERT ou DELETE).</span><span class="sxs-lookup"><span data-stu-id="1a3d2-246">Recall that `DataObjectMethodAttribute` is used to flag what methods should appear in the ObjectDataSource s Configure Data Source wizard and under what tab (SELECT, UPDATE, INSERT, or DELETE).</span></span> <span data-ttu-id="1a3d2-247">Étant donné que le contrôle GridView ne dispose pas de toute prise en charge intégrée pour la modification ou la suppression de lot, nous allons devoir appeler ces méthodes par programmation au lieu d’utiliser l’approche sans code déclaratif.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-247">Since the GridView lacks any built-in support for batch editing or deleting, we'll have to invoke these methods programmatically rather than use the code-free declarative approach.</span></span>


## <a name="step-5-atomically-updating-database-data-from-the-presentation-layer"></a><span data-ttu-id="1a3d2-248">Étape 5 : Mise à jour de manière atomique des données de base de données à partir de la couche de présentation</span><span class="sxs-lookup"><span data-stu-id="1a3d2-248">Step 5: Atomically Updating Database Data from the Presentation Layer</span></span>

<span data-ttu-id="1a3d2-249">Pour illustrer les effets de la transaction lors de la mise à jour d’un lot d’enregistrements, s permettent de créer une interface utilisateur qui répertorie tous les produits dans un GridView et inclut un bouton de serveur Web de contrôle qui, lorsque vous cliquez dessus, réaffecte les produits `CategoryID` valeurs.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-249">To illustrate the effect that the transaction has when updating a batch of records, let s create a user interface that lists all products in a GridView and includes a Button Web control that, when clicked, reassigns the products `CategoryID` values.</span></span> <span data-ttu-id="1a3d2-250">En particulier, de progression de la réaffectation de catégorie afin que la première série de produits est assignées valide `CategoryID` valeur alors que d’autres sont volontairement attribué un inexistant `CategoryID` valeur.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-250">In particular, the category reassignment will progress so that the first several products are assigned a valid `CategoryID` value while others are purposefully assigned a non-existent `CategoryID` value.</span></span> <span data-ttu-id="1a3d2-251">Si nous tentons de mettre à jour de la base de données avec un produit dont `CategoryID` ne correspond pas à une catégorie existante s `CategoryID`, se produit une violation de contrainte de clé étrangère et une exception sera levée.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-251">If we attempt to update the database with a product whose `CategoryID` does not match an existing category s `CategoryID`, a foreign key constraint violation will occur and an exception will be raised.</span></span> <span data-ttu-id="1a3d2-252">Nous verrons dans cet exemple est que, lorsque vous à l’aide d’une transaction, l’exception levée à partir de la violation de contrainte de clé étrangère entraînera la précédente valide `CategoryID` modifications être annulées.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-252">What we'll see in this example is that when using a transaction the exception raised from the foreign key constraint violation will cause the previous valid `CategoryID` changes to be rolled back.</span></span> <span data-ttu-id="1a3d2-253">Lorsque vous N'utilisez pas une transaction, toutefois, les modifications aux catégories initiales reste.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-253">When not using a transaction, however, the modifications to the initial categories will remain.</span></span>

<span data-ttu-id="1a3d2-254">Commencez par ouvrir le `Transactions.aspx` page dans le `BatchData` faites glisser un contrôle GridView à partir de la boîte à outils vers le concepteur.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-254">Start by opening the `Transactions.aspx` page in the `BatchData` folder and drag a GridView from the Toolbox onto the Designer.</span></span> <span data-ttu-id="1a3d2-255">Définir son `ID` à `Products` et, à partir de sa balise active, la lier à un nouveau ObjectDataSource nommé `ProductsDataSource`.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-255">Set its `ID` to `Products` and, from its smart tag, bind it to a new ObjectDataSource named `ProductsDataSource`.</span></span> <span data-ttu-id="1a3d2-256">Configurer l’ObjectDataSource à extraire ses données à partir de la `ProductsBLL` classe s `GetProducts` (méthode).</span><span class="sxs-lookup"><span data-stu-id="1a3d2-256">Configure the ObjectDataSource to pull its data from the `ProductsBLL` class s `GetProducts` method.</span></span> <span data-ttu-id="1a3d2-257">Ceci est un GridView en lecture seule, par conséquent, définie les listes déroulantes dans la mise à jour, insérer et supprimer des onglets (aucun) et cliquez sur Terminer.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-257">This will be a read-only GridView, so set the drop-down lists in the UPDATE, INSERT, and DELETE tabs to (None) and click Finish.</span></span>


<span data-ttu-id="1a3d2-258">[![Configurer pour utiliser la méthode GetProducts ProductsBLL classe s ObjectDataSource](wrapping-database-modifications-within-a-transaction-vb/_static/image5.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="1a3d2-258">[![Configure the ObjectDataSource to Use the ProductsBLL Class s GetProducts Method](wrapping-database-modifications-within-a-transaction-vb/_static/image5.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image3.png)</span></span>

<span data-ttu-id="1a3d2-259">**Figure 5**: configurer l’ObjectDataSource à utiliser le `ProductsBLL` classe s `GetProducts` (méthode) ([cliquez pour afficher l’image en taille réelle](wrapping-database-modifications-within-a-transaction-vb/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="1a3d2-259">**Figure 5**: Configure the ObjectDataSource to Use the `ProductsBLL` Class s `GetProducts` Method ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image4.png))</span></span>


<span data-ttu-id="1a3d2-260">[![Définir les listes déroulantes dans la mise à jour, insérer et supprimer des onglets à (None)](wrapping-database-modifications-within-a-transaction-vb/_static/image6.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="1a3d2-260">[![Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None)](wrapping-database-modifications-within-a-transaction-vb/_static/image6.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image5.png)</span></span>

<span data-ttu-id="1a3d2-261">**Figure 6**: définir les listes déroulantes dans la mise à jour, insérer et supprimer des onglets à (None) ([cliquez pour afficher l’image en taille réelle](wrapping-database-modifications-within-a-transaction-vb/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="1a3d2-261">**Figure 6**: Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None) ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image6.png))</span></span>


<span data-ttu-id="1a3d2-262">Après avoir terminé l’Assistant Configurer la Source de données, Visual Studio créera BoundFields et un CheckBoxField pour les champs de données de produit.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-262">After completing the Configure Data Source wizard, Visual Studio will create BoundFields and a CheckBoxField for the product data fields.</span></span> <span data-ttu-id="1a3d2-263">Supprimez tous ces champs à l’exception de `ProductID`, `ProductName`, `CategoryID`, et `CategoryName` et renommer le `ProductName` et `CategoryName` BoundFields `HeaderText` propriétés produit et de catégorie, respectivement.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-263">Remove all of these fields except for `ProductID`, `ProductName`, `CategoryID`, and `CategoryName` and rename the `ProductName` and `CategoryName` BoundFields `HeaderText` properties to Product and Category, respectively.</span></span> <span data-ttu-id="1a3d2-264">À partir de la balise active, activez l’option Activer la pagination.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-264">From the smart tag, check the Enable Paging option.</span></span> <span data-ttu-id="1a3d2-265">Après avoir apporté ces modifications, le balisage déclaratif s GridView et ObjectDataSource doit se présenter comme suit :</span><span class="sxs-lookup"><span data-stu-id="1a3d2-265">After making these modifications, the GridView and ObjectDataSource s declarative markup should look like the following:</span></span>


[!code-aspx[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample7.aspx)]

<span data-ttu-id="1a3d2-266">Ensuite, ajoutez trois contrôles de bouton Web ci-dessus le GridView.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-266">Next, add three Button Web controls above the GridView.</span></span> <span data-ttu-id="1a3d2-267">Définir le premier bouton s propriété Text pour actualiser la grille, le deuxième s afin de modifier les catégories (avec TRANSACTION) et le troisième un s pour modifier les catégories (sans TRANSACTION).</span><span class="sxs-lookup"><span data-stu-id="1a3d2-267">Set the first Button s Text property to Refresh Grid, the second s to Modify Categories (WITH TRANSACTION), and the third one s to Modify Categories (WITHOUT TRANSACTION) .</span></span>


[!code-aspx[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample8.aspx)]

<span data-ttu-id="1a3d2-268">À ce stade la vue de conception dans Visual Studio doit ressembler à l’écran : WordGame indiqué dans la Figure 7.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-268">At this point the Design view in Visual Studio should look similar to the screen shot shown in Figure 7.</span></span>


<span data-ttu-id="1a3d2-269">[![La Page contient un GridView et trois contrôles Web](wrapping-database-modifications-within-a-transaction-vb/_static/image7.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="1a3d2-269">[![The Page Contains a GridView and Three Button Web Controls](wrapping-database-modifications-within-a-transaction-vb/_static/image7.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image7.png)</span></span>

<span data-ttu-id="1a3d2-270">**Figure 7**: la Page contient un GridView et les trois contrôles Web ([cliquez pour afficher l’image en taille réelle](wrapping-database-modifications-within-a-transaction-vb/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="1a3d2-270">**Figure 7**: The Page Contains a GridView and Three Button Web Controls ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image8.png))</span></span>


<span data-ttu-id="1a3d2-271">Créer des gestionnaires d’événements pour chaque du bouton trois s `Click` événements et utiliser le code suivant :</span><span class="sxs-lookup"><span data-stu-id="1a3d2-271">Create event handlers for each of the three Button s `Click` events and use the following code:</span></span>


[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample9.vb)]

<span data-ttu-id="1a3d2-272">L’actualisation du bouton s `Click` Gestionnaire d’événements relie simplement les données au contrôle GridView en appelant le `Products` GridView s `DataBind` (méthode).</span><span class="sxs-lookup"><span data-stu-id="1a3d2-272">The refresh Button s `Click` event handler simply rebinds the data to the GridView by calling the `Products` GridView s `DataBind` method.</span></span>

<span data-ttu-id="1a3d2-273">Le second gestionnaire d’événements réaffecte les produits `CategoryID` s et utilise la nouvelle méthode de transaction à partir de la couche BLL pour effectuer la base de données met à jour dans le cadre d’une transaction.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-273">The second event handler reassigns the products `CategoryID` s and uses the new transaction method from the BLL to perform the database updates under the umbrella of a transaction.</span></span> <span data-ttu-id="1a3d2-274">Notez que chaque produit s `CategoryID` est arbitrairement définie sur la même valeur que sa `ProductID`.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-274">Note that each product s `CategoryID` is arbitrarily set to the same value as its `ProductID`.</span></span> <span data-ttu-id="1a3d2-275">Cela fonctionne correctement pour la première certains produits, étant donné que ces produits `ProductID` les valeurs qui se produisent à mapper à valide `CategoryID` s.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-275">This will work fine for the first few products, since those products have `ProductID` values that happen to map to valid `CategoryID` s.</span></span> <span data-ttu-id="1a3d2-276">Mais une fois la `ProductID` début s devient trop volumineux, ce chevauchement une coïncidence de `ProductID` s et `CategoryID` s ne s’applique plus.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-276">But once the `ProductID` s start getting too large, this coincidental overlap of `ProductID` s and `CategoryID` s no longer applies.</span></span>

<span data-ttu-id="1a3d2-277">La troisième `Click` Gestionnaire d’événements met à jour les produits `CategoryID` s de la même manière, mais envoie la mise à jour la base de données à l’aide de la `ProductsTableAdapter` par défaut de s `Update` (méthode).</span><span class="sxs-lookup"><span data-stu-id="1a3d2-277">The third `Click` event handler updates the products `CategoryID` s in the same manner, but sends the update to the database using the `ProductsTableAdapter` s default `Update` method.</span></span> <span data-ttu-id="1a3d2-278">Cela `Update` n’encapsule pas la série de commandes dans une transaction d’une méthode, afin de ces modifications sont apportées avant la première erreur de violation de contrainte de clé étrangère a été rencontrée seront conservés.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-278">This `Update` method does not wrap the series of commands within a transaction, so those changes are made prior to the first encountered foreign key constraint violation error will persist.</span></span>

<span data-ttu-id="1a3d2-279">Pour illustrer ce comportement, visitez cette page via un navigateur.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-279">To demonstrate this behavior, visit this page through a browser.</span></span> <span data-ttu-id="1a3d2-280">Au départ, vous devez voir la première page de données comme indiqué dans la Figure 8.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-280">Initially you should see the first page of data as shown in Figure 8.</span></span> <span data-ttu-id="1a3d2-281">Ensuite, cliquez sur le bouton Modifier les catégories (avec TRANSACTION).</span><span class="sxs-lookup"><span data-stu-id="1a3d2-281">Next, click the Modify Categories (WITH TRANSACTION) button.</span></span> <span data-ttu-id="1a3d2-282">Cela provoque une publication (postback) et tentez de mettre à jour tous les produits `CategoryID` des valeurs, mais entraîne une violation de contrainte de clé étrangère (voir la Figure 9).</span><span class="sxs-lookup"><span data-stu-id="1a3d2-282">This will cause a postback and attempt to update all of the products `CategoryID` values, but will result in a foreign key constraint violation (see Figure 9).</span></span>


<span data-ttu-id="1a3d2-283">[![Les produits sont affichés dans un GridView paginable](wrapping-database-modifications-within-a-transaction-vb/_static/image8.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="1a3d2-283">[![The Products are Displayed in a Pageable GridView](wrapping-database-modifications-within-a-transaction-vb/_static/image8.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image9.png)</span></span>

<span data-ttu-id="1a3d2-284">**Figure 8**: les produits sont affichés dans un GridView paginable ([cliquez pour afficher l’image en taille réelle](wrapping-database-modifications-within-a-transaction-vb/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="1a3d2-284">**Figure 8**: The Products are Displayed in a Pageable GridView ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image10.png))</span></span>


<span data-ttu-id="1a3d2-285">[![Réaffecter les résultats de catégories une violation de contrainte de clé étrangère](wrapping-database-modifications-within-a-transaction-vb/_static/image9.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="1a3d2-285">[![Reassigning the Categories Results in a Foreign Key Constraint Violation](wrapping-database-modifications-within-a-transaction-vb/_static/image9.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image11.png)</span></span>

<span data-ttu-id="1a3d2-286">**Figure 9**: en réaffectant les résultats de catégories dans une Violation de contrainte de clé étrangère ([cliquez pour afficher l’image en taille réelle](wrapping-database-modifications-within-a-transaction-vb/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="1a3d2-286">**Figure 9**: Reassigning the Categories Results in a Foreign Key Constraint Violation ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image12.png))</span></span>


<span data-ttu-id="1a3d2-287">Maintenant atteint votre bouton précédent de navigateur s et puis cliquez sur le bouton Actualiser la grille.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-287">Now hit your browser s Back button and then click the Refresh Grid button.</span></span> <span data-ttu-id="1a3d2-288">Lors de l’actualisation des données, vous devez voir le même résultat exactement comme indiqué dans la Figure 8.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-288">Upon refreshing the data you should see the exact same output as shown in Figure 8.</span></span> <span data-ttu-id="1a3d2-289">Autrement dit, même si certains produits `CategoryID` s ont les valeurs modifiées pour juridique et mis à jour dans la base de données, ils ont été restaurées lors de la violation de contrainte de clé étrangère s’est produite.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-289">That is, even though some of the products `CategoryID` s were changed to legal values and updated in the database, they were rolled back when the foreign key constraint violation occurred.</span></span>

<span data-ttu-id="1a3d2-290">Essayez maintenant en cliquant sur le bouton Modifier les catégories (sans TRANSACTION).</span><span class="sxs-lookup"><span data-stu-id="1a3d2-290">Now try clicking the Modify Categories (WITHOUT TRANSACTION) button.</span></span> <span data-ttu-id="1a3d2-291">Cela entraîne la même erreur de violation de contrainte de clé étrangère (voir Figure 9), mais cette fois, les produits dont `CategoryID` valeurs ont été modifiées pour une juridiques valeur ne sera pas restaurée.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-291">This will result in the same foreign key constraint violation error (see Figure 9), but this time those products whose `CategoryID` values were changed to a legal value will not be rolled back.</span></span> <span data-ttu-id="1a3d2-292">Appuyez sur le bouton précédent de navigateur s, puis sur le bouton Actualiser la grille.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-292">Hit your browser s Back button and then the Refresh Grid button.</span></span> <span data-ttu-id="1a3d2-293">Comme le montre la Figure 10, le `CategoryID` s des huit premiers produits ont été réassigné.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-293">As Figure 10 shows, the `CategoryID` s of the first eight products have been reassigned.</span></span> <span data-ttu-id="1a3d2-294">Par exemple, dans la Figure 8, suivi modifications avaient un `CategoryID` 1, mais dans la Figure 10 informatique s réaffectée à 2.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-294">For example, in Figure 8, Chang had a `CategoryID` of 1, but in Figure 10 it s been reassigned to 2.</span></span>


<span data-ttu-id="1a3d2-295">[![Certaines valeurs de CategoryID produits ont été mis à jour tandis que d’autres ont été pas](wrapping-database-modifications-within-a-transaction-vb/_static/image10.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="1a3d2-295">[![Some Products CategoryID Values were Updated While Others Were Not](wrapping-database-modifications-within-a-transaction-vb/_static/image10.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image13.png)</span></span>

<span data-ttu-id="1a3d2-296">**La figure 10**: certains produits `CategoryID` valeurs ont été mis à jour tandis que d’autres ont été pas ([cliquez pour afficher l’image en taille réelle](wrapping-database-modifications-within-a-transaction-vb/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="1a3d2-296">**Figure 10**: Some Products `CategoryID` Values were Updated While Others Were Not ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image14.png))</span></span>


## <a name="summary"></a><span data-ttu-id="1a3d2-297">Résumé</span><span class="sxs-lookup"><span data-stu-id="1a3d2-297">Summary</span></span>

<span data-ttu-id="1a3d2-298">Par défaut, les méthodes de s TableAdapter n’imbriquez pas les instructions de la base de données exécutée dans l’étendue d’une transaction, mais avec un peu de travail, nous pouvons ajouter les méthodes que vous allez créer, commit et rollback une transaction.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-298">By default, the TableAdapter s methods do not wrap the executed database statements within the scope of a transaction, but with a little work we can add methods that will create, commit, and rollback a transaction.</span></span> <span data-ttu-id="1a3d2-299">Dans ce didacticiel, nous avons créé trois de ces méthodes dans les `ProductsTableAdapter` classe : `BeginTransaction`, `CommitTransaction`, et `RollbackTransaction`.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-299">In this tutorial we created three such methods in the `ProductsTableAdapter` class: `BeginTransaction`, `CommitTransaction`, and `RollbackTransaction`.</span></span> <span data-ttu-id="1a3d2-300">Nous avons vu comment utiliser ces méthodes avec un `Try...Catch` bloc pour effectuer une série d’instructions de modification de données atomique.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-300">We saw how to use these methods along with a `Try...Catch` block to make a series of data modification statements atomic.</span></span> <span data-ttu-id="1a3d2-301">En particulier, nous avons créé la `UpdateWithTransaction` méthode dans le `ProductsTableAdapter`, qui utilise le modèle de mise à jour par lots pour effectuer les modifications nécessaires aux lignes d’une `ProductsDataTable`.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-301">In particular, we created the `UpdateWithTransaction` method in the `ProductsTableAdapter`, which uses the Batch Update pattern to perform the necessary modifications to the rows of a supplied `ProductsDataTable`.</span></span> <span data-ttu-id="1a3d2-302">Nous avons également ajouté la `DeleteProductsWithTransaction` méthode à la `ProductsBLL` classe dans la couche BLL, qui accepte un `List` de `ProductID` les valeurs en entrée et appelle la méthode de modèle Direct à la base de données `Delete` pour chaque `ProductID`.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-302">We also added the `DeleteProductsWithTransaction` method to the `ProductsBLL` class in the BLL, which accepts a `List` of `ProductID` values as its input and calls the DB-Direct pattern method `Delete` for each `ProductID`.</span></span> <span data-ttu-id="1a3d2-303">Les deux méthodes démarrer en créant une transaction et puis d’exécuter les instructions de modification de données dans un `Try...Catch` bloc.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-303">Both methods start by creating a transaction and then executing the data modification statements within a `Try...Catch` block.</span></span> <span data-ttu-id="1a3d2-304">Si une exception se produit, la transaction est restaurée, dans le cas contraire, il est validé.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-304">If an exception occurs, the transaction is rolled back, otherwise it is committed.</span></span>

<span data-ttu-id="1a3d2-305">Étape 5 illustre l’effet des mises à jour de lot transactionnel et mises à jour par lots a négligé d’utiliser une transaction.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-305">Step 5 illustrated the effect of transactional batch updates versus batch updates that neglected to use a transaction.</span></span> <span data-ttu-id="1a3d2-306">Dans les trois didacticiels nous reposent sur la base de ce didacticiel et créer des interfaces utilisateur pour effectuer des insertions, suppressions et mises à jour par lots.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-306">In the next three tutorials we will build upon the foundation laid in this tutorial and create user interfaces for performing batch updates, deletes, and inserts.</span></span>

<span data-ttu-id="1a3d2-307">Bonne programmation !</span><span class="sxs-lookup"><span data-stu-id="1a3d2-307">Happy Programming!</span></span>

## <a name="further-reading"></a><span data-ttu-id="1a3d2-308">informations supplémentaires</span><span class="sxs-lookup"><span data-stu-id="1a3d2-308">Further Reading</span></span>

<span data-ttu-id="1a3d2-309">Pour plus d’informations sur les sujets abordés dans ce didacticiel, consultez les ressources suivantes :</span><span class="sxs-lookup"><span data-stu-id="1a3d2-309">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="1a3d2-310">Maintenir la cohérence de base de données avec des Transactions</span><span class="sxs-lookup"><span data-stu-id="1a3d2-310">Maintaining Database Consistency with Transactions</span></span>](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx)
- [<span data-ttu-id="1a3d2-311">Procédures stockées de gestion des Transactions dans SQL Server</span><span class="sxs-lookup"><span data-stu-id="1a3d2-311">Managing Transactions in SQL Server Stored Procedures</span></span>](http://www.4guysfromrolla.com/webtech/080305-1.shtml)
- [<span data-ttu-id="1a3d2-312">Transactions effectuées simples :`System.Transactions`</span><span class="sxs-lookup"><span data-stu-id="1a3d2-312">Transactions Made Easy: `System.Transactions`</span></span>](https://blogs.msdn.com/florinlazar/archive/2004/07/23/192239.aspx)
- [<span data-ttu-id="1a3d2-313">TransactionScope et DataAdapters</span><span class="sxs-lookup"><span data-stu-id="1a3d2-313">TransactionScope and DataAdapters</span></span>](http://andyclymer.blogspot.com/2007/01/transactionscope-and-dataadapters.html)
- [<span data-ttu-id="1a3d2-314">À l’aide de Transactions de bases de données Oracle dans .NET</span><span class="sxs-lookup"><span data-stu-id="1a3d2-314">Using Oracle Database Transactions in .NET</span></span>](http://www.oracle.com/technology/pub/articles/price_dbtrans_dotnet.html)

## <a name="about-the-author"></a><span data-ttu-id="1a3d2-315">À propos de l’auteur</span><span class="sxs-lookup"><span data-stu-id="1a3d2-315">About the Author</span></span>

<span data-ttu-id="1a3d2-316">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), auteur de sept manuels ASP/ASP.NET et créateur de [4GuysFromRolla.com](http://www.4guysfromrolla.com), travaille avec les technologies Web Microsoft depuis 1998.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-316">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="1a3d2-317">Scott fonctionne comme un consultant indépendant, formateur et writer.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-317">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="1a3d2-318">Son dernier ouvrage est [ *SAM animer vous-même ASP.NET 2.0 des dernières 24 heures*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="1a3d2-318">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="1a3d2-319">Il peut être atteint à [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) ou via son blog, qui se trouvent à [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="1a3d2-319">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="1a3d2-320">Remerciements</span><span class="sxs-lookup"><span data-stu-id="1a3d2-320">Special Thanks To</span></span>

<span data-ttu-id="1a3d2-321">Cette série de didacticiels a été révisée par plusieurs réviseurs utiles.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-321">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="1a3d2-322">Les réviseurs tête pour ce didacticiel ont Dave Gardner, Hilton Giesenow et Teresa Murphy.</span><span class="sxs-lookup"><span data-stu-id="1a3d2-322">Lead reviewers for this tutorial were Dave Gardner, Hilton Giesenow, and Teresa Murphy.</span></span> <span data-ttu-id="1a3d2-323">Vous souhaitez consulter mes prochains articles MSDN ?</span><span class="sxs-lookup"><span data-stu-id="1a3d2-323">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="1a3d2-324">Dans ce cas, me supprimer une ligne à [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="1a3d2-324">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

>[!div class="step-by-step"]
<span data-ttu-id="1a3d2-325">[Précédent](batch-inserting-cs.md)
[Suivant](batch-updating-vb.md)</span><span class="sxs-lookup"><span data-stu-id="1a3d2-325">[Previous](batch-inserting-cs.md)
[Next](batch-updating-vb.md)</span></span>
