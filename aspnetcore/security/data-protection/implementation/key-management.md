---
title: Gestion des clés dans ASP.NET Core
author: rick-anderson
description: Découvrez les détails de l’implémentation des API de gestion de clés de protection des données ASP.NET Core.
ms.author: riande
ms.date: 10/14/2016
uid: security/data-protection/implementation/key-management
ms.openlocfilehash: c571222d734fa69183563aefa5cc6ce5a10e7612
ms.sourcegitcommit: 9a129f5f3e31cc449742b164d5004894bfca90aa
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 03/06/2020
ms.locfileid: "78664709"
---
# <a name="key-management-in-aspnet-core"></a><span data-ttu-id="4d9db-103">Gestion des clés dans ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="4d9db-103">Key management in ASP.NET Core</span></span>

<a name="data-protection-implementation-key-management"></a>

<span data-ttu-id="4d9db-104">Le système de protection des données gère automatiquement la durée de vie des clés principales utilisées pour protéger et ôter la protection des charges utiles.</span><span class="sxs-lookup"><span data-stu-id="4d9db-104">The data protection system automatically manages the lifetime of master keys used to protect and unprotect payloads.</span></span> <span data-ttu-id="4d9db-105">Chaque clé peut exister dans l’une des quatre étapes suivantes :</span><span class="sxs-lookup"><span data-stu-id="4d9db-105">Each key can exist in one of four stages:</span></span>

* <span data-ttu-id="4d9db-106">Créé : la clé existe dans le Ring Key, mais n’a pas encore été activée.</span><span class="sxs-lookup"><span data-stu-id="4d9db-106">Created - the key exists in the key ring but has not yet been activated.</span></span> <span data-ttu-id="4d9db-107">La clé ne doit pas être utilisée pour les nouvelles opérations de protection jusqu’à ce que la durée de la propagation de la clé soit suffisante pour tous les ordinateurs qui consomment cette sonnerie de clé.</span><span class="sxs-lookup"><span data-stu-id="4d9db-107">The key shouldn't be used for new Protect operations until sufficient time has elapsed that the key has had a chance to propagate to all machines that are consuming this key ring.</span></span>

* <span data-ttu-id="4d9db-108">Actif : la clé existe dans l’anneau clé et doit être utilisée pour toutes les nouvelles opérations de protection.</span><span class="sxs-lookup"><span data-stu-id="4d9db-108">Active - the key exists in the key ring and should be used for all new Protect operations.</span></span>

* <span data-ttu-id="4d9db-109">Expiré : la clé a exécuté sa durée de vie naturelle et ne doit plus être utilisée pour les nouvelles opérations de protection.</span><span class="sxs-lookup"><span data-stu-id="4d9db-109">Expired - the key has run its natural lifetime and should no longer be used for new Protect operations.</span></span>

* <span data-ttu-id="4d9db-110">Révoqué : la clé est compromise et ne doit pas être utilisée pour les nouvelles opérations de protection.</span><span class="sxs-lookup"><span data-stu-id="4d9db-110">Revoked - the key is compromised and must not be used for new Protect operations.</span></span>

<span data-ttu-id="4d9db-111">Les clés créées, actives et expirées peuvent toutes être utilisées pour ôter la protection des charges utiles entrantes.</span><span class="sxs-lookup"><span data-stu-id="4d9db-111">Created, active, and expired keys may all be used to unprotect incoming payloads.</span></span> <span data-ttu-id="4d9db-112">Les clés révoquées par défaut ne peuvent pas être utilisées pour ôter la protection des charges utiles, mais le développeur de l’application peut [remplacer ce comportement](xref:security/data-protection/consumer-apis/dangerous-unprotect#data-protection-consumer-apis-dangerous-unprotect) si nécessaire.</span><span class="sxs-lookup"><span data-stu-id="4d9db-112">Revoked keys by default may not be used to unprotect payloads, but the application developer can [override this behavior](xref:security/data-protection/consumer-apis/dangerous-unprotect#data-protection-consumer-apis-dangerous-unprotect) if necessary.</span></span>

>[!WARNING]
> <span data-ttu-id="4d9db-113">Le développeur peut être tenté de supprimer une clé de l’anneau clé (par exemple, en supprimant le fichier correspondant du système de fichiers).</span><span class="sxs-lookup"><span data-stu-id="4d9db-113">The developer might be tempted to delete a key from the key ring (e.g., by deleting the corresponding file from the file system).</span></span> <span data-ttu-id="4d9db-114">À ce stade, toutes les données protégées par la clé sont définitivement déchiffrables, et il n’y a pas de remplacement d’urgence comme c’est le cas avec les clés révoquées.</span><span class="sxs-lookup"><span data-stu-id="4d9db-114">At that point, all data protected by the key is permanently undecipherable, and there's no emergency override like there's with revoked keys.</span></span> <span data-ttu-id="4d9db-115">La suppression d’une clé est véritablement un comportement destructif et, par conséquent, le système de protection des données n’expose aucune API de première classe pour effectuer cette opération.</span><span class="sxs-lookup"><span data-stu-id="4d9db-115">Deleting a key is truly destructive behavior, and consequently the data protection system exposes no first-class API for performing this operation.</span></span>

## <a name="default-key-selection"></a><span data-ttu-id="4d9db-116">Sélection de clé par défaut</span><span class="sxs-lookup"><span data-stu-id="4d9db-116">Default key selection</span></span>

<span data-ttu-id="4d9db-117">Lorsque le système de protection des données lit l’anneau de clé à partir du référentiel de sauvegarde, il tente de localiser une clé « par défaut » dans l’anneau de clé.</span><span class="sxs-lookup"><span data-stu-id="4d9db-117">When the data protection system reads the key ring from the backing repository, it will attempt to locate a "default" key from the key ring.</span></span> <span data-ttu-id="4d9db-118">La clé par défaut est utilisée pour les nouvelles opérations de protection.</span><span class="sxs-lookup"><span data-stu-id="4d9db-118">The default key is used for new Protect operations.</span></span>

<span data-ttu-id="4d9db-119">L’heuristique générale est que le système de protection des données choisit la clé avec la date d’activation la plus récente comme clé par défaut.</span><span class="sxs-lookup"><span data-stu-id="4d9db-119">The general heuristic is that the data protection system chooses the key with the most recent activation date as the default key.</span></span> <span data-ttu-id="4d9db-120">(Il y a un petit facteur manœuvre pour permettre la distorsion des horloges de serveur à serveur.) Si la clé a expiré ou est révoquée, et si l’application n’a pas désactivé la génération de clé automatique, une nouvelle clé sera générée avec l’activation immédiate en fonction de la stratégie [d’expiration et de déroulement](xref:security/data-protection/implementation/key-management#data-protection-implementation-key-management-expiration) de la clé ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="4d9db-120">(There's a small fudge factor to allow for server-to-server clock skew.) If the key is expired or revoked, and if the application has not disabled automatic key generation, then a new key will be generated with immediate activation per the [key expiration and rolling](xref:security/data-protection/implementation/key-management#data-protection-implementation-key-management-expiration) policy below.</span></span>

<span data-ttu-id="4d9db-121">La raison pour laquelle le système de protection des données génère une nouvelle clé immédiatement, plutôt que de revenir à une clé différente, est que la nouvelle génération de clé doit être traitée comme une expiration implicite de toutes les clés qui ont été activées avant la nouvelle clé.</span><span class="sxs-lookup"><span data-stu-id="4d9db-121">The reason the data protection system generates a new key immediately rather than falling back to a different key is that new key generation should be treated as an implicit expiration of all keys that were activated prior to the new key.</span></span> <span data-ttu-id="4d9db-122">L’idée générale est que de nouvelles clés peuvent avoir été configurées avec des algorithmes ou des mécanismes de chiffrement au repos différents de ceux des anciennes clés, et que le système doit préférer la configuration actuelle à la restauration.</span><span class="sxs-lookup"><span data-stu-id="4d9db-122">The general idea is that new keys may have been configured with different algorithms or encryption-at-rest mechanisms than old keys, and the system should prefer the current configuration over falling back.</span></span>

<span data-ttu-id="4d9db-123">Il y a une exception.</span><span class="sxs-lookup"><span data-stu-id="4d9db-123">There's an exception.</span></span> <span data-ttu-id="4d9db-124">Si le développeur de l’application a [désactivé la génération de clé automatique](xref:security/data-protection/configuration/overview#disableautomatickeygeneration), le système de protection des données doit choisir un nom comme clé par défaut.</span><span class="sxs-lookup"><span data-stu-id="4d9db-124">If the application developer has [disabled automatic key generation](xref:security/data-protection/configuration/overview#disableautomatickeygeneration), then the data protection system must choose something as the default key.</span></span> <span data-ttu-id="4d9db-125">Dans ce scénario de secours, le système choisit la clé non révoquée avec la date d’activation la plus récente, avec la préférence donnée aux clés qui ont eu le temps de se propager aux autres ordinateurs du cluster.</span><span class="sxs-lookup"><span data-stu-id="4d9db-125">In this fallback scenario, the system will choose the non-revoked key with the most recent activation date, with preference given to keys that have had time to propagate to other machines in the cluster.</span></span> <span data-ttu-id="4d9db-126">En conséquence, le système de secours peut finir par choisir une clé par défaut expirée.</span><span class="sxs-lookup"><span data-stu-id="4d9db-126">The fallback system may end up choosing an expired default key as a result.</span></span> <span data-ttu-id="4d9db-127">Le système de secours ne choisit jamais une clé révoquée comme clé par défaut, et si l’anneau de clé est vide ou si chaque clé a été révoquée, le système génère une erreur lors de l’initialisation.</span><span class="sxs-lookup"><span data-stu-id="4d9db-127">The fallback system will never choose a revoked key as the default key, and if the key ring is empty or every key has been revoked then the system will produce an error upon initialization.</span></span>

<a name="data-protection-implementation-key-management-expiration"></a>

## <a name="key-expiration-and-rolling"></a><span data-ttu-id="4d9db-128">Expiration et déroulement de la clé</span><span class="sxs-lookup"><span data-stu-id="4d9db-128">Key expiration and rolling</span></span>

<span data-ttu-id="4d9db-129">Quand une clé est créée, elle reçoit automatiquement la date d’activation {Now + 2 days} et la date d’expiration {Now + 90 jours}.</span><span class="sxs-lookup"><span data-stu-id="4d9db-129">When a key is created, it's automatically given an activation date of { now + 2 days } and an expiration date of { now + 90 days }.</span></span> <span data-ttu-id="4d9db-130">Le délai de 2 jours avant l’activation indique que la durée de la clé doit être retournée dans le système.</span><span class="sxs-lookup"><span data-stu-id="4d9db-130">The 2-day delay before activation gives the key time to propagate through the system.</span></span> <span data-ttu-id="4d9db-131">Autrement dit, il permet à d’autres applications qui pointent dans le magasin de stockage d’observer la clé lors de leur prochaine période d’actualisation automatique, ce qui optimise les chances que lorsque l’anneau de clé devient actif, il est propagé à toutes les applications qui peuvent avoir besoin de l’utiliser.</span><span class="sxs-lookup"><span data-stu-id="4d9db-131">That is, it allows other applications pointing at the backing store to observe the key at their next auto-refresh period, thus maximizing the chances that when the key ring does become active it has propagated to all applications that might need to use it.</span></span>

<span data-ttu-id="4d9db-132">Si la clé par défaut expire dans 2 jours et si l’anneau de clé n’a pas encore de clé qui sera active à l’expiration de la clé par défaut, le système de protection des données conserve automatiquement une nouvelle clé de l’anneau de clé.</span><span class="sxs-lookup"><span data-stu-id="4d9db-132">If the default key will expire within 2 days and if the key ring doesn't already have a key that will be active upon expiration of the default key, then the data protection system will automatically persist a new key to the key ring.</span></span> <span data-ttu-id="4d9db-133">Cette nouvelle clé a une date d’activation de {date d’expiration de la clé par défaut} et une date d’expiration de {Now + 90 jours}.</span><span class="sxs-lookup"><span data-stu-id="4d9db-133">This new key has an activation date of { default key's expiration date } and an expiration date of { now + 90 days }.</span></span> <span data-ttu-id="4d9db-134">Cela permet au système de répercuter automatiquement les clés régulièrement sans interruption de service.</span><span class="sxs-lookup"><span data-stu-id="4d9db-134">This allows the system to automatically roll keys on a regular basis with no interruption of service.</span></span>

<span data-ttu-id="4d9db-135">Dans certains cas, une clé est créée avec l’activation immédiate.</span><span class="sxs-lookup"><span data-stu-id="4d9db-135">There might be circumstances where a key will be created with immediate activation.</span></span> <span data-ttu-id="4d9db-136">Par exemple, si l’application n’est pas exécutée pendant une durée et que toutes les clés de l’anneau de clé ont expiré.</span><span class="sxs-lookup"><span data-stu-id="4d9db-136">One example would be when the application hasn't run for a time and all keys in the key ring are expired.</span></span> <span data-ttu-id="4d9db-137">Dans ce cas, la clé reçoit la date d’activation {Now} sans délai d’activation normal de 2 jours.</span><span class="sxs-lookup"><span data-stu-id="4d9db-137">When this happens, the key is given an activation date of { now } without the normal 2-day activation delay.</span></span>

<span data-ttu-id="4d9db-138">La durée de vie de la clé par défaut est de 90 jours, bien que cela soit configurable comme dans l’exemple suivant.</span><span class="sxs-lookup"><span data-stu-id="4d9db-138">The default key lifetime is 90 days, though this is configurable as in the following example.</span></span>

```csharp
services.AddDataProtection()
       // use 14-day lifetime instead of 90-day lifetime
       .SetDefaultKeyLifetime(TimeSpan.FromDays(14));
```

<span data-ttu-id="4d9db-139">Un administrateur peut également modifier l’ensemble du système par défaut, bien qu’un appel explicite à `SetDefaultKeyLifetime` remplace toute stratégie à l’niveau du système.</span><span class="sxs-lookup"><span data-stu-id="4d9db-139">An administrator can also change the default system-wide, though an explicit call to `SetDefaultKeyLifetime` will override any system-wide policy.</span></span> <span data-ttu-id="4d9db-140">La durée de vie de la clé par défaut ne peut pas être inférieure à 7 jours.</span><span class="sxs-lookup"><span data-stu-id="4d9db-140">The default key lifetime cannot be shorter than 7 days.</span></span>

## <a name="automatic-key-ring-refresh"></a><span data-ttu-id="4d9db-141">Actualisation automatique des sonneries de touche</span><span class="sxs-lookup"><span data-stu-id="4d9db-141">Automatic key ring refresh</span></span>

<span data-ttu-id="4d9db-142">Lorsque le système de protection des données est initialisé, il lit l’anneau de clé à partir du référentiel sous-jacent et le met en cache dans la mémoire.</span><span class="sxs-lookup"><span data-stu-id="4d9db-142">When the data protection system initializes, it reads the key ring from the underlying repository and caches it in memory.</span></span> <span data-ttu-id="4d9db-143">Ce cache permet de procéder à des opérations de protection et d’annulation de la protection sans toucher au magasin de stockage.</span><span class="sxs-lookup"><span data-stu-id="4d9db-143">This cache allows Protect and Unprotect operations to proceed without hitting the backing store.</span></span> <span data-ttu-id="4d9db-144">Le système recherche automatiquement les modifications dans le magasin de stockage environ toutes les 24 heures, ou à l’expiration de la clé par défaut actuelle.</span><span class="sxs-lookup"><span data-stu-id="4d9db-144">The system will automatically check the backing store for changes approximately every 24 hours or when the current default key expires, whichever comes first.</span></span>

>[!WARNING]
> <span data-ttu-id="4d9db-145">Les développeurs doivent très rarement (voire jamais) utiliser directement les API de gestion de clés.</span><span class="sxs-lookup"><span data-stu-id="4d9db-145">Developers should very rarely (if ever) need to use the key management APIs directly.</span></span> <span data-ttu-id="4d9db-146">Le système de protection des données effectuera la gestion automatique des clés comme décrit ci-dessus.</span><span class="sxs-lookup"><span data-stu-id="4d9db-146">The data protection system will perform automatic key management as described above.</span></span>

<span data-ttu-id="4d9db-147">Le système de protection des données expose une interface `IKeyManager` qui peut être utilisée pour inspecter et apporter des modifications à l’anneau de clé.</span><span class="sxs-lookup"><span data-stu-id="4d9db-147">The data protection system exposes an interface `IKeyManager` that can be used to inspect and make changes to the key ring.</span></span> <span data-ttu-id="4d9db-148">Le système DI qui a fourni l’instance de `IDataProtectionProvider` peut également fournir une instance de `IKeyManager` pour votre consommation.</span><span class="sxs-lookup"><span data-stu-id="4d9db-148">The DI system that provided the instance of `IDataProtectionProvider` can also provide an instance of `IKeyManager` for your consumption.</span></span> <span data-ttu-id="4d9db-149">Vous pouvez également extraire les `IKeyManager` directement à partir de la `IServiceProvider` comme dans l’exemple ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="4d9db-149">Alternatively, you can pull the `IKeyManager` straight from the `IServiceProvider` as in the example below.</span></span>

<span data-ttu-id="4d9db-150">Toute opération qui modifie l’anneau de clé (création explicite d’une nouvelle clé ou exécution d’un révocation) invalidera le cache en mémoire.</span><span class="sxs-lookup"><span data-stu-id="4d9db-150">Any operation which modifies the key ring (creating a new key explicitly or performing a revocation) will invalidate the in-memory cache.</span></span> <span data-ttu-id="4d9db-151">Le prochain appel à `Protect` ou `Unprotect` entraînera la relecture par le système de protection des données de l’anneau de clé et la recréation du cache.</span><span class="sxs-lookup"><span data-stu-id="4d9db-151">The next call to `Protect` or `Unprotect` will cause the data protection system to reread the key ring and recreate the cache.</span></span>

<span data-ttu-id="4d9db-152">L’exemple ci-dessous illustre l’utilisation de l’interface `IKeyManager` pour inspecter et manipuler l’anneau clé, y compris la révocation manuelle des clés existantes et la génération manuelle d’une nouvelle clé.</span><span class="sxs-lookup"><span data-stu-id="4d9db-152">The sample below demonstrates using the `IKeyManager` interface to inspect and manipulate the key ring, including revoking existing keys and generating a new key manually.</span></span>

[!code-csharp[](key-management/samples/key-management.cs)]

[!INCLUDE[about the series](~/includes/code-comments-loc.md)]

## <a name="key-storage"></a><span data-ttu-id="4d9db-153">Stockage des clés</span><span class="sxs-lookup"><span data-stu-id="4d9db-153">Key storage</span></span>

<span data-ttu-id="4d9db-154">Le système de protection des données a un heuristique qui tente de déduire automatiquement un emplacement de stockage de clé approprié et un mécanisme de chiffrement au repos.</span><span class="sxs-lookup"><span data-stu-id="4d9db-154">The data protection system has a heuristic whereby it attempts to deduce an appropriate key storage location and encryption-at-rest mechanism automatically.</span></span> <span data-ttu-id="4d9db-155">Le mécanisme de persistance des clés est également configurable par le développeur de l’application.</span><span class="sxs-lookup"><span data-stu-id="4d9db-155">The key persistence mechanism is also configurable by the app developer.</span></span> <span data-ttu-id="4d9db-156">Les documents suivants décrivent les implémentations intégrées de ces mécanismes :</span><span class="sxs-lookup"><span data-stu-id="4d9db-156">The following documents discuss the in-box implementations of these mechanisms:</span></span>

* <xref:security/data-protection/implementation/key-storage-providers>
* <xref:security/data-protection/implementation/key-encryption-at-rest>
